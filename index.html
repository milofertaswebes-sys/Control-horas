<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üìã Control de Horas</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Iconos -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <!-- Estilos propios -->
  <style>
    /* ====== Estilos Globales ====== */
    :root {
      --bg-grad-start: #1e3c72;
      --bg-grad-end: #2a5298;
      --text-contrast-strong: #4c1d95; /* p√∫rpura m√°s oscuro para contraste */
      --banner-bg: #10b981; /* verde */
      --banner-text: #053b2f;
    }
    html[data-theme="dark"] {
      --bg-grad-start: #0f172a;
      --bg-grad-end: #1f2937;
      --text-contrast-strong: #7c3aed;
      --banner-bg: #059669;
      --banner-text: #e6fffb;
    }

    body {
      background: linear-gradient(135deg, var(--bg-grad-start), var(--bg-grad-end));
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
    }

    /* Tarjetas */
    .card {
      background: #fff;
      border-radius: 1rem;
      box-shadow: 0 6px 16px rgba(0,0,0,0.1);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    html[data-theme="dark"] .card { background: #111827; color: #e5e7eb; }
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    }

    /* Botones */
    .btn {
      padding: 0.6rem 1rem;
      border-radius: 0.75rem;
      font-weight: 600;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.4rem;
      cursor: pointer;
      transition: transform 0.15s ease, opacity 0.2s ease, box-shadow 0.15s ease;
    }
    .btn:hover {
      transform: translateY(-1px);
      opacity: 0.95;
      box-shadow: 0 6px 14px rgba(0,0,0,0.15);
    }
    .btn:active {
      transform: translateY(0);
      box-shadow: none;
    }
    .btn-green { background: linear-gradient(90deg, #38a169, #2f855a); }
    .btn-red { background: linear-gradient(90deg, #e53e3e, #c53030); }
    .btn-blue { background: linear-gradient(90deg, #3182ce, #2b6cb0); }
    .btn-orange { background: linear-gradient(90deg, #dd6b20, #c05621); }
    .btn-purple { background: linear-gradient(90deg, #805ad5, #6b46c1); }
    .btn-gray { background: linear-gradient(90deg, #718096, #4a5568); }

    /* Header */
    .header-gradient {
      background: linear-gradient(90deg, #667eea, #764ba2);
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      border-radius: 0.75rem;
    }

    /* Tabla */
    table {
      border-collapse: separate;
      border-spacing: 0;
      width: 100%;
    }
    th, td {
      text-align: left;
      padding: 12px 16px;
      border-bottom: 1px solid #e2e8f0;
      white-space: nowrap;
    }
    th {
      background: #edf2f7;
      font-weight: bold;
      color: #2d3748;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    tr:nth-child(even) td {
      background: #f7fafc;
    }
    html[data-theme="dark"] th { background: #1f2937; color: #e5e7eb; }
    html[data-theme="dark"] td { border-bottom-color: #374151; }
    html[data-theme="dark"] tr:nth-child(even) td { background: #111827; }

    /* Primera columna sticky (para m√≥viles) */
    #tablaHoras th:first-child,
    #tablaHoras td:first-child {
      position: sticky;
      left: 0;
      background: #ffffff;
      z-index: 2;
    }
    html[data-theme="dark"] #tablaHoras th:first-child,
    html[data-theme="dark"] #tablaHoras td:first-child {
      background: #0b1220;
    }

    /* Animaciones y feedback */
    .floating { animation: floating 3s ease-in-out infinite; }
    @keyframes floating {
      0% { transform: translateY(0); }
      50% { transform: translateY(-6px); }
      100% { transform: translateY(0); }
    }
    .pulse { animation: pulse 2s infinite; }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(66,153,225,0.6); }
      70% { box-shadow: 0 0 0 10px rgba(66,153,225,0); }
      100% { box-shadow: 0 0 0 0 rgba(66,153,225,0); }
    }
    .pressable:active { transform: scale(0.98); }

    .last-action {
      outline: 2px solid #10b981;
      background: #ecfdf5 !important;
    }
    html[data-theme="dark"] .last-action {
      outline-color: #34d399;
      background: #064e3b !important;
      color: #d1fae5;
    }

    /* Scroll personalizado */
    ::-webkit-scrollbar { width: 10px; height: 10px; }
    ::-webkit-scrollbar-thumb {
      background: #667eea;
      border-radius: 6px;
    }
    ::-webkit-scrollbar-thumb:hover { background: #764ba2; }

    /* ====== Toasts inferiores (las mantengo para info secundaria) ====== */
    .toast-container {
      position: fixed;
      right: 16px;
      bottom: 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 9998;
    }
    .toast {
      min-width: 260px;
      color: #1a202c;
      background: #fff;
      border-left: 6px solid #718096;
      border-radius: 10px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.15);
      padding: 12px 14px;
      animation: slideIn 0.2s ease-out;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .toast.success { border-left-color: #38a169; }
    .toast.error { border-left-color: #e53e3e; }
    .toast.warning { border-left-color: #dd6b20; }
    .toast.info { border-left-color: #3182ce; }
    .toast .icon { font-size: 18px; }
    @keyframes slideIn {
      from { transform: translateY(8px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    /* ====== Banner superior grande (confirmaciones principales) ====== */
    .top-banner {
      position: sticky;
      top: 0;
      z-index: 10000;
      width: 100%;
      padding: 14px 18px;
      background: var(--banner-bg);
      color: var(--banner-text);
      font-weight: 700;
      text-align: center;
      border-bottom: 2px solid rgba(0,0,0,0.1);
      box-shadow: 0 6px 14px rgba(0,0,0,0.1);
    }

    /* Contraste reforzado para cifras clave */
    .contrast-strong { color: var(--text-contrast-strong); }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 10001;
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background: white;
      border-radius: 1rem;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }
    html[data-theme="dark"] .modal-content {
      background: #1f2937;
      color: #e5e7eb;
    }

    /* Login */
    .login-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10002;
    }

    /* Ojo de contrase√±a */
    .password-toggle {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
      color: #6b7280;
    }
    .password-container {
      position: relative;
      width: 100%;
    }

    /* Botones de acci√≥n en tabla */
    .action-btn {
      padding: 0.25rem 0.5rem;
      border-radius: 0.375rem;
      font-size: 0.875rem;
      margin: 0 0.125rem;
    }

    /* Modal Cambio de Contrase√±a */
    .modal-password {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 10001;
      align-items: center;
      justify-content: center;
    }
    .modal-password-content {
      background: white;
      border-radius: 1rem;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      max-width: 500px;
      width: 90%;
      padding: 24px;
    }
    html[data-theme="dark"] .modal-password-content {
      background: #1f2937;
      color: #e5e7eb;
    }
  </style>

  <!-- PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.4/jspdf.plugin.autotable.min.js"></script>

  <!-- Charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
 
  <script type="module">
	   // --- crea el MOTOR para tablas en Firebase ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
	  import { getFirestore, collection, addDoc, getDocs, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCI1nLERKCHwMluF5NYbBgLuxmUbJ6REmQ",
            authDomain: "controlhorasgines.firebaseapp.com",
            projectId: "controlhorasgines",
            storageBucket: "controlhorasgines.firebasestorage.app",
            messagingSenderId: "32537920791",
            appId: "1:32537920791:web:d1852e2e6220e71913a352"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Hacemos que la base de datos y las funciones de Firebase sean accesibles
        window.dbCloud = db;
        window.addDoc = addDoc;
        window.collection = collection;
	  window.getDocs = getDocs;
window.query = query;
window.orderBy = orderBy;
	  
// --- L√çNEA 335: NUEVA FUNCI√ìN DE DESCARGA AUT√ìNOMA ---
	async function descargarDatosNube() {
    console.log("üì° [PC 1] Iniciando descarga directa...");

    try {
        // 1. LEER TRABAJADORES
        // Accedemos al documento 'unico' dentro de la colecci√≥n 'trabajadores_v2026'
        const docRefT = doc(db, "trabajadores_v2026", "unico");
        const docSnapT = await getDoc(docRefT);

        if (docSnapT.exists()) {
            const dataT = docSnapT.data().data;
            if (Array.isArray(dataT)) {
                trabajadores = dataT;
                localStorage.setItem('trabajadores', JSON.stringify(trabajadores));
                console.log(`‚úÖ ¬°√âXITO! ${trabajadores.length} trabajadores bajados.`);
            }
        }

        // 2. LEER REGISTROS (HORAS)
        const docRefR = doc(db, "registros_v2026", "unico");
        const docSnapR = await getDoc(docRefR);

        if (docSnapR.exists()) {
            const dataR = docSnapR.data().data;
            if (Array.isArray(dataR)) {
                fichajes = dataR;
                localStorage.setItem('fichajes', JSON.stringify(fichajes));
                console.log(`‚úÖ ¬°√âXITO! ${fichajes.length} fichajes bajados.`);
            }
        }

        // 3. ACTUALIZAR PANTALLA
        console.log("üé® Actualizando tabla...");
        if (typeof actualizarSelector === 'function') actualizarSelector();
        if (typeof renderTabla === 'function') renderTabla();

    } catch (error) {
        console.error("‚ùå Error en la descarga:", error);
        // Si el error sigue siendo "doc is not defined", es que falta importar doc y getDoc arriba
        console.log("Sugerencia: Revisa si arriba del todo tienes: import { doc, getDoc } ... ");
    }
}
// --- INICIO AUTOM√ÅTICO ---
setTimeout(() => {
    descargarDatosNube();
}, 2000);

</script>
</head>
<body class="p-4">
  <div id="top-banner" class="top-banner" role="status" aria-live="polite" aria-atomic="true" hidden></div>

  <div id="loginContainer" class="login-container">
    <div class="card p-8 max-w-md w-full">
      <h2 class="text-2xl font-bold text-center mb-6">üîê Acceso al Sistema</h2>
      <div class="space-y-4">
        <label class="block">
          <span class="text-sm font-medium">Usuario</span>
          <input type="text" id="loginUsuario" class="w-full mt-1" placeholder="admin o usuario" />
        </label>
        <label class="block">
          <span class="text-sm font-medium">Contrase√±a</span>
          <div class="password-container">
            <input type="password" id="loginPassword" class="w-full mt-1" placeholder="admin123 o user123" />
            <span class="password-toggle" id="toggleLoginPassword">
              <i class="fas fa-eye"></i>
            </span>
          </div>
        </label>
        <button id="btnLogin" class="btn btn-blue w-full">
          <i class="fas fa-sign-in-alt mr-2"></i>Iniciar Sesi√≥n
        </button>
        <div id="loginError" class="text-red-500 text-sm hidden"></div>
      </div>
    </div>
  </div>

  <div id="modalRegistroManual" class="modal">
    <div class="modal-content p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold">‚ûï Registro Manual de Horas</h3>
        <button id="cerrarModal" class="text-2xl">&times;</button>
      </div>
      <div class="space-y-4">
        <label class="block">
          <span class="text-sm font-medium">Trabajador</span>
          <select id="manualTrabajador" class="w-full mt-1"></select>
        </label>
        <label class="block">
          <span class="text-sm font-medium">Fecha</span>
          <input type="date" id="manualFecha" class="w-full mt-1" />
        </label>
        <div class="grid grid-cols-2 gap-4">
          <label class="block">
            <span class="text-sm font-medium">Entrada (HH:MM)</span>
            <input type="time" id="manualEntrada" class="w-full mt-1" />
          </label>
          <label class="block">
            <span class="text-sm font-medium">Salida (HH:MM)</span>
            <input type="time" id="manualSalida" class="w-full mt-1" />
          </label>
        </div>
        <div class="flex gap-3 pt-4">
          <button id="btnGuardarManual" class="btn btn-green flex-1">
            <i class="fas fa-save mr-2"></i>Guardar
          </button>
          <button id="btnCancelarManual" class="btn btn-gray flex-1">
            <i class="fas fa-times mr-2"></i>Cancelar
          </button>
        </div>
      </div>
    </div>
  </div>
  <!-- Modal para editar registro -->
  <div id="modalEditarRegistro" class="modal">
    <div class="modal-content p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold">‚úèÔ∏è Editar Registro</h3>
        <button id="cerrarModalEditar" class="text-2xl">&times;</button>
      </div>
      <div class="space-y-4">
        <input type="hidden" id="editarRegistroId" />
        <label class="block">
          <span class="text-sm font-medium">Trabajador</span>
          <select id="editarTrabajador" class="w-full mt-1" disabled></select>
        </label>
        <label class="block">
          <span class="text-sm font-medium">Fecha</span>
          <input type="date" id="editarFecha" class="w-full mt-1" />
        </label>
        <div class="grid grid-cols-2 gap-4">
          <label class="block">
            <span class="text-sm font-medium">Entrada (HH:MM)</span>
            <input type="time" id="editarEntrada" class="w-full mt-1" />
          </label>
          <label class="block">
            <span class="text-sm font-medium">Salida (HH:MM)</span>
            <input type="time" id="editarSalida" class="w-full mt-1" />
          </label>
        </div>
        <div class="flex gap-3 pt-4">
          <button id="btnGuardarEditar" class="btn btn-green flex-1">
            <i class="fas fa-save mr-2"></i>Guardar
          </button>
          <button id="btnCancelarEditar" class="btn btn-gray flex-1">
            <i class="fas fa-times mr-2"></i>Cancelar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para cambio de contrase√±a -->
  <div id="modalCambioPass" class="modal-password">
    <div class="modal-password-content p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold">üîë Cambiar Contrase√±a</h3>
        <button id="cerrarModalCambioPass" class="text-2xl">&times;</button>
      </div>
      <div class="space-y-4">
        <label class="block">
          <span class="text-sm font-medium">Usuario</span>
          <select id="selectUsuarioPass" class="w-full mt-1">
            <option value="admin">admin</option>
            <option value="usuario">usuario</option>
          </select>
        </label>
        <label class="block">
          <span class="text-sm font-medium">Nueva Contrase√±a</span>
          <div class="password-container">
            <input type="password" id="nuevaPassword" class="w-full mt-1" placeholder="Introduce nueva contrase√±a" />
            <span class="password-toggle" id="toggleNewPassword">
              <i class="fas fa-eye"></i>
            </span>
          </div>
        </label>
        <label class="block">
          <span class="text-sm font-medium">Confirmar Contrase√±a</span>
          <div class="password-container">
            <input type="password" id="confirmarPassword" class="w-full mt-1" placeholder="Confirma la nueva contrase√±a" />
            <span class="password-toggle" id="toggleConfirmPassword">
              <i class="fas fa-eye"></i>
            </span>
          </div>
        </label>
        <div class="flex gap-3 pt-4">
          <button id="btnGuardarCambioPass" class="btn btn-green flex-1">
            <i class="fas fa-save mr-2"></i>Guardar
          </button>
          <button id="btnCancelarCambioPass" class="btn btn-gray flex-1">
            <i class="fas fa-times mr-2"></i>Cancelar
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="max-w-7xl mx-auto">

    <!-- T√≠tulo -->
    <header class="text-center mb-8">
      <h1 class="text-4xl md:text-5xl font-bold text-white mb-2 floating">
        <i class="fas fa-clock mr-3"></i>Control de Horas
      </h1>
      <p class="text-xl text-white opacity-90">Sistema inteligente para gesti√≥n de tiempo</p>
      <div class="mt-4 flex items-center justify-center gap-3">
        <button id="toggleTheme" class="btn btn-gray" aria-label="Cambiar tema claro u oscuro">
          <i class="fas fa-adjust mr-2"></i><span id="themeText">Modo oscuro</span>
        </button>
        <button id="btnLogout" class="btn btn-red">
          <i class="fas fa-sign-out-alt mr-2"></i>Salir
        </button>
      </div>
    </header>

    <!-- Panel -->
    <main class="card p-8 mb-8" aria-label="Panel principal de control de horas">

      <!-- Encabezado -->
      <div class="header-gradient text-white p-6 rounded-xl mb-6 text-center">
        <h2 class="text-3xl font-bold">
          <i class="fas fa-user-clock mr-3"></i>Sistema de Control de Horas
        </h2>
        <p class="opacity-90 mt-2">Datos guardados localmente en tu navegador</p>
      </div>

      <!-- Grid principal -->
      <div class="grid sm:grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 mb-8">

        <!-- Alta -->
        <section class="card p-6 border-2 border-green-200" aria-label="Alta de trabajador">
          <header class="flex items-center mb-4">
            <div class="bg-green-100 p-3 rounded-full mr-3" aria-hidden="true">
              <i class="fas fa-user-plus text-green-600 text-xl"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-800">‚ûï Alta de Trabajador</h3>
          </header>
          <div class="space-y-4">
            <label class="block">
              <span class="text-sm font-medium text-gray-700">Nombre Completo</span>
              <input id="inputNombre" type="text" maxlength="60" placeholder="Ej: Juan P√©rez" class="w-full" required aria-label="Nombre completo del trabajador" />
            </label>
            <label class="block">
              <span class="text-sm font-medium text-gray-700">Documento de Identidad (DNI/NIE)</span>
              <input id="inputDNI" type="text" maxlength="15" placeholder="Ej: 12345678Z o X1234567L" class="w-full" required aria-label="Documento de identidad del trabajador" />
            </label>
            <button id="btnAlta" class="btn btn-green w-full" aria-label="Dar de alta trabajador">
              <i class="fas fa-save mr-2"></i>Dar de Alta
            </button>
          </div>
        </section>

        <!-- Baja -->
        <section class="card p-6 border-2 border-red-200" aria-label="Baja de trabajador">
          <header class="flex items-center mb-4">
            <div class="bg-red-100 p-3 rounded-full mr-3" aria-hidden="true">
              <i class="fas fa-user-minus text-red-600 text-xl"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-800">‚ûñ Baja de Trabajador</h3>
          </header>
          <div class="space-y-4">
            <div class="flex items-center gap-3">
              <label class="inline-flex items-center gap-2">
                <input type="radio" name="bajaTipo" value="numero" checked />
                <span>N¬∫</span>
              </label>
              <label class="inline-flex items-center gap-2">
                <input type="radio" name="bajaTipo" value="dni" />
                <span>DNI</span>
              </label>
            </div>
            <label class="block">
              <span class="text-sm font-medium text-gray-700">Identificador</span>
              <input id="inputBaja" type="text" placeholder="Introduce N¬∫ o DNI seg√∫n selecci√≥n" class="w-full" aria-label="Identificador para dar de baja: n√∫mero o DNI" />
            </label>
            <button id="btnBaja" class="btn btn-red w-full" aria-label="Dar de baja trabajador seleccionado">
              <i class="fas fa-trash-alt mr-2"></i>Dar de Baja
            </button>
          </div>
        </section>

        <!-- Registro Entrada/Salida -->
        <section class="card p-6 border-2 border-blue-200" aria-label="Registrar entrada o salida">
          <header class="flex items-center mb-4">
            <div class="bg-blue-100 p-3 rounded-full mr-3" aria-hidden="true">
              <i class="fas fa-clock text-blue-600 text-xl"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-800">üïì Registrar Entrada/Salida</h3>
          </header>
          <div class="space-y-4">
            <div class="flex items-center gap-3">
              <label class="inline-flex items-center gap-2">
                <input type="radio" name="regTipo" value="numero" checked />
                <span>N¬∫</span>
              </label>
              <label class="inline-flex items-center gap-2">
                <input type="radio" name="regTipo" value="dni" />
                <span>DNI</span>
              </label>
            </div>
            <label class="block">
              <span class="text-sm font-medium text-gray-700">Identificador</span>
              <input id="inputRegistro" type="text" placeholder="Escribe N¬∫ o DNI y pulsa Enter o bot√≥n" class="w-full pulse" aria-label="Identificador de trabajador: n√∫mero o DNI" />
            </label>
            <div class="bg-blue-50 p-3 rounded-lg text-sm text-blue-800">
              <i class="fas fa-info-circle mr-2" aria-hidden="true"></i>
              Sin registro abierto hoy ‚Üí <b>Entrada</b>. Si hay entrada sin salida ‚Üí <b>Salida</b>. Permite <b>varios tramos</b> al d√≠a.
            </div>
            <button id="btnRegistro" class="btn btn-blue w-full pressable" aria-label="Registrar ahora">
              <i class="fas fa-fingerprint mr-2"></i>Registrar Ahora
            </button>
          </div>
        </section>

      </div>

      <!-- Filtros -->
      <section class="bg-gray-50 p-6 rounded-xl mb-8" aria-label="Filtros de registros">
        <h3 class="text-lg font-semibold mb-4 text-gray-800">
          <i class="fas fa-filter mr-2"></i>Filtrar Registros
        </h3>
        <div class="grid sm:grid-cols-1 md:grid-cols-8 gap-4 items-end">
          <label>
            <span class="text-sm font-medium text-gray-700">Trabajador</span>
            <select id="selectorTrabajador" class="w-full" aria-label="Selector de trabajador"></select>
          </label>
          <label>
            <span class="text-sm font-medium text-gray-700">Mes</span>
            <input type="month" id="mesSeleccionado" class="w-full" aria-label="Seleccionar mes" />
          </label>
          <label>
            <span class="text-sm font-medium text-gray-700">Desde</span>
            <input type="date" id="fDesde" class="w-full" aria-label="Fecha desde" />
          </label>
          <label>
            <span class="text-sm font-medium text-gray-700">Hasta</span>
            <input type="date" id="fHasta" class="w-full" aria-label="Fecha hasta" />
          </label>
          <button id="btnExportar" class="btn btn-orange w-full" aria-label="Exportar en CSV">
            <i class="fas fa-file-export mr-2"></i>CSV
          </button>
          <button id="btnExportarExcel" class="btn btn-purple w-full" aria-label="Exportar en Excel">
            <i class="fas fa-file-excel mr-2"></i>Excel
          </button>
          <button id="btnExportarPDF" class="btn btn-red w-full" aria-label="Exportar en PDF">
            <i class="fas fa-file-pdf mr-2"></i>PDF
          </button>
          <button id="btnExportarPDFResumen" class="btn btn-green w-full" aria-label="Exportar resumen en PDF">
            <i class="fas fa-file-alt mr-2"></i>Resumen PDF
          </button>
        </div>

        <!-- Resumen mensual autom√°tico -->
        <div id="resumenMensual" class="mt-4 hidden">
          <div class="p-4 rounded-lg bg-emerald-50 border border-emerald-200 text-emerald-900">
            <strong>Resumen del mes seleccionado:</strong>
            <div class="mt-2 text-sm" id="resumenMensualContenido"></div>
          </div>
        </div>

        <!-- Progreso de horas -->
        <div id="panelProgreso" class="mt-4 hidden">
          <h4 class="font-semibold mb-2">Progreso de horas vs objetivo</h4>
          <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
            <div id="barraProgreso" class="bg-emerald-500 h-3" style="width:0%"></div>
          </div>
          <div class="text-sm mt-1 text-gray-700">
            <span id="textoProgreso">0 / 0 h</span>
          </div>
        </div>
      </section>

      <!-- Backup / Restore -->
      <section class="bg-gray-50 p-6 rounded-xl mb-8 flex gap-4" aria-label="Copia de seguridad y restauraci√≥n">
        <button id="btnBackup" class="btn btn-gray flex-1" aria-label="Descargar copia de seguridad">
          <i class="fas fa-download mr-2"></i>Backup
        </button>
        <label class="btn btn-gray flex-1 cursor-pointer" aria-label="Restaurar datos desde archivo">
          <i class="fas fa-upload mr-2"></i>Restaurar
          <input type="file" id="inputRestore" accept="application/json" hidden />
        </label>
        <button id="btnRegistroManual" class="btn btn-blue flex-1" aria-label="Registro manual de horas">
          <i class="fas fa-edit mr-2"></i>Registro Manual
        </button>
        <button id="btnCambioPass" class="btn btn-purple flex-1" aria-label="Cambiar contrase√±a">
          <i class="fas fa-key mr-2"></i>Cambiar Pass
        </button>
      </section>

      <!-- üìä Gr√°ficas -->
      <section class="bg-gray-50 p-6 rounded-xl mb-8" aria-label="Gr√°ficas de horas">
        <h3 class="text-lg font-semibold mb-4 text-gray-800">
          <i class="fas fa-chart-bar mr-2"></i>Estad√≠sticas
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <h4 class="text-center font-bold mb-2">Horas por Semana</h4>
            <canvas id="chartSemanal" height="200" aria-label="Gr√°fico de horas por semana"></canvas>
          </div>
          <div>
            <h4 class="text-center font-bold mb-2">Horas por Mes</h4>
            <canvas id="chartMensual" height="200" aria-label="Gr√°fico de horas por mes"></canvas>
          </div>
        </div>
      </section>

      <!-- Tabla -->
      <section class="bg-gray-50 p-6 rounded-xl" aria-label="Tabla de registros">
        <header class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold text-gray-800">
            <i class="fas fa-table mr-2"></i>Registro de Horas
          </h3>
          <div class="text-lg font-bold text-purple-700 contrast-strong">
            Total del per√≠odo: <span id="totalHoras" class="text-2xl">0.00</span> h
          </div>
        </header>
        <div class="overflow-auto max-h-96 rounded-lg shadow">
          <table id="tablaHoras" class="min-w-full bg-white">
            <thead class="sticky top-0 bg-gray-100">
              <tr>
                <th>Trabajador N¬∫</th>
                <th>Fecha</th>
                <th>Entrada</th>
                <th>Salida</th>
                <th>Horas (tramo)</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="6" class="text-center py-8 text-gray-500">
                  <i class="fas fa-search fa-2x mb-2" aria-hidden="true"></i>
                  <p>Selecciona trabajador y rango/mes para ver los registros</p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>
    </main>

    <!-- Footer -->
    <footer class="text-center text-white opacity-80">
      <p>¬© Sistema de Control de Horas</p>
    </footer>
  </div>

  <div id="toast-container" class="toast-container" aria-live="polite" aria-atomic="true"></div>

  <!-- JS principal -->
  <script>
    /***************************************************
     * UTILIDADES GENERALES
     ***************************************************/
    const supportsLocalStorage = (() => {
      try {
        const k = "__tst__";
        window.localStorage.setItem(k, "1");
        window.localStorage.removeItem(k);
        return true;
      } catch {
        return false;
      }
    })();

    function lsSet(key, value) {
      try {
        localStorage.setItem(key, JSON.stringify(value));
		
// --- INICIO C√ìDIGO CLOUD ---
try {
    if (window.dbCloud) {
        // CORRECCI√ìN: Usamos "registros_v2026" para que coincida con la descarga
        const cloudCol = window.collection(window.dbCloud, "registros_v2026");

        window.addDoc(cloudCol, {
            // Clasifica autom√°ticamente si es la lista de nombres o un fichaje
            tipo_dato: (key === 'trabajadores') ? "trabajadores" : "fichajes",
            contenido: value, 
            timestamp: new Date().toISOString(),
            usuario: "Sistema_Gines"
        });
        console.log("‚úÖ Sincronizado en la colecci√≥n registros_v2026");
    }
} catch (e) {
    console.error("‚ùå Error al sincronizar con la nube:", e);
}
// --- FIN C√ìDIGO CLOUD ---
      } catch (e) {
        showBanner("‚ö†Ô∏è No se pudo guardar en este navegador (localStorage).", "warning");
        throw e;
      }
    }
    function lsGet(key, fallback) {
      try {
        const v = localStorage.getItem(key);
        return v ? JSON.parse(v) : fallback;
      } catch {
        return fallback;
      }
    }

    function showBanner(msg, type = "success") {
      const banner = document.getElementById("top-banner");
      banner.textContent = msg;
      banner.style.background = type === "success" ? "var(--banner-bg)" :
                                type === "error"   ? "#ef4444" :
                                type === "warning" ? "#f59e0b" : "#3b82f6";
      banner.hidden = false;
      clearTimeout(showBanner._t);
      showBanner._t = setTimeout(() => { banner.hidden = true; }, 3000);
    }

    function notify(msg, type = "info") {
      const container = document.getElementById("toast-container");
      const toast = document.createElement("div");
      toast.className = `toast ${type}`;
      const icon = document.createElement("span");
      icon.className = "icon";
      icon.innerHTML = ({ success:"‚úÖ", error:"‚õî", warning:"‚ö†Ô∏è", info:"‚ÑπÔ∏è" })[type] || "‚ÑπÔ∏è";
      const text = document.createElement("div");
      text.textContent = msg;
      toast.appendChild(icon);
      toast.appendChild(text);
      container.appendChild(toast);
      setTimeout(() => {
        toast.style.opacity = "0";
        toast.style.transform = "translateY(6px)";
        setTimeout(() => toast.remove(), 200);
      }, 2500);
    }

    function cryptoRandomId() {
      if (window.crypto?.getRandomValues) {
        const buf = new Uint32Array(2);
        crypto.getRandomValues(buf);
        return [...buf].map(n => n.toString(16)).join("");
      }
      return (Date.now().toString(16) + Math.random().toString(16).slice(2));
    }

    function formatTimeForRender(hhmmss) {
      try {
        const today = new Date().toISOString().slice(0,10);
        return new Date(`${today}T${hhmmss}`).toLocaleTimeString();
      } catch {
        return hhmmss;
      }
    }

    function getWeekNumber(d) {
      const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
      const dayNum = date.getUTCDay() || 7;
      date.setUTCDate(date.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(date.getUTCFullYear(),0,1));
      return Math.ceil(((date - yearStart) / 86400000 + 1)/7);
    }

    function downloadBlob(filename, mime, content) {
      const blob = new Blob([content], { type: mime });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    /***************************************************
     * AUTH
     ***************************************************/
    const DEFAULT_USUARIOS = {
      admin: { password: "admin123", rol: "admin" },
      usuario: { password: "user123", rol: "usuario" }
    };

    let usuarios = lsGet("usuarios", DEFAULT_USUARIOS);
    let usuarioActual = null;

    function login(usuario, password) {
      const user = usuarios[usuario];
      if (user && user.password === password) {
        usuarioActual = { nombre: usuario, rol: user.rol };
        lsSet("usuarioActual", usuarioActual);
        document.getElementById("loginContainer").style.display = "none";
        document.getElementById("btnRegistroManual").style.display = 
          usuarioActual.rol === "admin" ? "block" : "none";
        document.getElementById("btnCambioPass").style.display = 
          usuarioActual.rol === "admin" ? "block" : "none";
        showBanner(`‚úÖ Bienvenido, ${usuario} (${user.rol})`, "success");
        return true;
      }
      return false;
    }

    function logout() {
      usuarioActual = null;
      lsSet("usuarioActual", null);
      document.getElementById("loginContainer").style.display = "flex";
      document.getElementById("loginUsuario").value = "";
      document.getElementById("loginPassword").value = "";
      document.getElementById("loginError").classList.add("hidden");
    }

    function cambiarPassword(usuario, nuevaPass) {
      if (usuarios[usuario]) {
        usuarios[usuario].password = nuevaPass;
        lsSet("usuarios", usuarios);
        return true;
      }
      return false;
    }

    /***************************************************
     * THEME
     ***************************************************/
    function applyTheme(theme) {
      document.documentElement.setAttribute("data-theme", theme);
      const tText = document.getElementById("themeText");
      if (tText) tText.textContent = theme === "dark" ? "Modo claro" : "Modo oscuro";
      lsSet("theme", theme);
    }

    /***************************************************
     * STORAGE
     ***************************************************/
    if (!supportsLocalStorage) {
      alert("Este navegador no soporta localStorage. La app no podr√° guardar los datos.");
    }

    let trabajadores = lsGet("trabajadores", []);
    let registros = lsGet("registros", []);

    /** Persiste todo */
    function guardarDatos() {
      lsSet("trabajadores", trabajadores);
      lsSet("registros", registros);
    }

    /***************************************************
     * VALIDACIONES
     ***************************************************/
    function validarNombre(nombre) {
      return !!String(nombre || "").trim();
    }
    
    function validarDNI(dni) {
      const DNI_REGEX = /^(?:\d{8}[A-Za-z]|[XYZ]\d{7}[A-Za-z])$/;
      const val = DNI_REGEX.test(String(dni || "").toUpperCase());
      console.log('[DEBUG validarDNI]', dni, '->', val);
      
      if (!val) return false;
      
      // Validaci√≥n de letra
      const dniStr = String(dni).toUpperCase();
      const map = { X: 0, Y: 1, Z: 2 };
      let num = dniStr;
      let letra = num.slice(-1);
      let cuerpo = num.slice(0, -1).replace(/[XYZ]/, (c) => map[c]);
      const letras = "TRWAGMYFPDXBNJZSQVHLCKE";
      return letras[parseInt(cuerpo, 10) % 23] === letra;
    }

    /***************************************************
     * UI HELPERS
     ***************************************************/
    function actualizarSelector() {
      const selector = document.getElementById("selectorTrabajador");
      selector.innerHTML = '<option value="">-- Selecciona --</option>';
      selector.innerHTML += '<option value="ALL">Todos los trabajadores</option>';
      trabajadores.sort((a,b)=>a.numero-b.numero).forEach(t => {
        const estado = t.estado || "Activo";
        selector.innerHTML += `<option value="${t.id}">${t.numero} - ${t.nombre} - ${t.dni} (${estado})</option>`;
      });
      
      // Actualizar selector del modal manual
      const manualSelector = document.getElementById("manualTrabajador");
      manualSelector.innerHTML = '';
      trabajadores.filter(t => (t.estado || "Activo") === "Activo").forEach(t => {
        manualSelector.innerHTML += `<option value="${t.id}">${t.numero} - ${t.nombre}</option>`;
      });
      
      // Actualizar selector del modal editar
      const editarSelector = document.getElementById("editarTrabajador");
      editarSelector.innerHTML = '';
      trabajadores.forEach(t => {
        editarSelector.innerHTML += `<option value="${t.id}">${t.numero} - ${t.nombre}</option>`;
      });
    }

    /***************************************************
     * WORKERS
     ***************************************************/
   // --- FUNCIONES CORREGIDAS PARA ENVIAR AL PC 2 ---

async function altaTrabajador(nombre, dni) {
    console.log('[DEBUG altaTrabajador] nombre=', nombre, 'dni=', dni);

    if (!validarNombre(nombre)) {
        showBanner("‚ùå El nombre no puede estar vac√≠o.", "error");
        return;
    }
    if (!validarDNI(dni)) {
        showBanner("‚ùå DNI/NIE no v√°lido.", "error");
        return;
    }
    // Convertimos a String para evitar errores si el DNI es solo n√∫meros
    if (trabajadores.some(t => String(t.dni).toUpperCase() === String(dni).toUpperCase())) {
        showBanner("‚ùå Ya existe un trabajador con ese DNI/NIE.", "error");
        return;
    }

    const nextNumber = trabajadores.length ? Math.max(...trabajadores.map(t => t.numero)) + 1 : 1;
    
    const nuevo = {
        id: cryptoRandomId(),
        numero: nextNumber,
        nombre: nombre.trim(),
        dni: String(dni).toUpperCase(),
        estado: "Activo"
    };

    trabajadores.push(nuevo);
    
    // 1. Guardamos en TU ordenador
    guardarDatos(); 

    // 2. ENVIAMOS AL PC 2 (ESTO ES LO QUE FALTABA)
    if (typeof subirDatosNube === 'function') {
        console.log("‚òÅÔ∏è Subiendo nuevo trabajador a la nube...");
        await subirDatosNube('trabajadores_v2026', trabajadores);
    }

    // 3. Actualizamos la pantalla
    if (typeof actualizarSelector === 'function') actualizarSelector();
    if (typeof renderTabla === 'function') renderTabla(); // Para refrescar si tienes lista visible
    
    showBanner(`‚úÖ Alta: ${nuevo.nombre} (n¬∫ ${nuevo.numero})`, "success");
}

async function bajaTrabajador(valor, tipo) {
    let trabajador;
    if (tipo === "dni") {
        trabajador = trabajadores.find(t => String(t.dni).toUpperCase() === String(valor).toUpperCase());
    } else {
        trabajador = trabajadores.find(t => t.numero == valor);
    }

    if (!trabajador) { showBanner("‚ùå Trabajador no encontrado.", "error"); return; }
    if (!confirm(`¬øSeguro que quieres dar de baja al trabajador ${trabajador.nombre}?`)) return;

    trabajador.estado = "Baja";
    
    // 1. Guardamos en TU ordenador
    guardarDatos();

    // 2. ENVIAMOS LA BAJA AL PC 2
    if (typeof subirDatosNube === 'function') {
        console.log("‚òÅÔ∏è Sincronizando baja en la nube...");
        await subirDatosNube('trabajadores_v2026', trabajadores);
    }

    if (typeof actualizarSelector === 'function') actualizarSelector();
    
    showBanner(`üõë Baja: ${trabajador.nombre}`, "success");
}

    /***************************************************
     * RECORDS
     ***************************************************/
    function buscarTrabajadorPorInput(valor, tipo) {
      if (tipo === "dni") {
        return trabajadores.find(t => t.dni.toUpperCase() === String(valor).toUpperCase());
      }
      return trabajadores.find(t => t.numero == valor);
    }

    function registrarEntradaSalida(valor, tipo) {
      const trabajador = buscarTrabajadorPorInput(valor, tipo);
      if (!trabajador) return showBanner("‚ùå Trabajador no encontrado.", "error");
      if ((trabajador.estado || "Activo") !== "Activo") return showBanner("üö´ El trabajador est√° de baja.", "warning");

      const hoy = new Date().toISOString().slice(0,10);
      let abierto = registros.find(r => r.fecha === hoy && r.trabajadorId === trabajador.id && !r.salidaISO);

      if (!abierto) {
        // Registrar entrada
        const ahora = new Date();
        const ahoraISO = ahora.toTimeString().slice(0,8);
        const reg = { 
          id: cryptoRandomId(), 
          fecha: hoy, 
          entradaISO: ahoraISO, 
          salidaISO: "", 
          horas: 0, 
          trabajadorId: trabajador.id 
        };
        registros.push(reg);
        guardarDatos();
        refreshUI();
        showBanner(`üü¢ Entrada registrada: ${trabajador.nombre} (n¬∫ ${trabajador.numero}) a las ${formatTimeForRender(ahoraISO)}`, "success");
      } else {
        // Registrar salida
        const ahora = new Date();
        const ahoraISO = ahora.toTimeString().slice(0,8);
        abierto.salidaISO = ahoraISO;
        
        // Calcular horas correctamente
        const entrada = new Date(`${abierto.fecha}T${abierto.entradaISO}`);
        const salida = new Date(`${abierto.fecha}T${abierto.salidaISO}`);
        const diffMs = salida - entrada;
        const diffHrs = diffMs / (1000 * 60 * 60);
        const horas = Math.max(0, Math.round(diffHrs * 100) / 100);
        abierto.horas = horas;
        
        guardarDatos();
        refreshUI();
        showBanner(`üîµ Salida registrada: ${trabajador.nombre} (n¬∫ ${trabajador.numero}) a las ${formatTimeForRender(ahoraISO)}`, "success");
      }
    }

    /***************************************************
     * REGISTRO MANUAL
     ***************************************************/
    function abrirModalRegistroManual() {
      if (usuarioActual.rol !== "admin") {
        showBanner("üö´ Acceso denegado. Solo administradores.", "error");
        return;
      }
      const modal = document.getElementById("modalRegistroManual");
      const fechaInput = document.getElementById("manualFecha");
      fechaInput.value = new Date().toISOString().slice(0,10);
      modal.style.display = "flex";
    }

    function cerrarModalRegistroManual() {
      document.getElementById("modalRegistroManual").style.display = "none";
    }

    function guardarRegistroManual() {
      const trabajadorId = document.getElementById("manualTrabajador").value;
      const fecha = document.getElementById("manualFecha").value;
      const entrada = document.getElementById("manualEntrada").value;
      const salida = document.getElementById("manualSalida").value;

      if (!trabajadorId || !fecha || !entrada || !salida) {
        showBanner("‚ùå Todos los campos son obligatorios.", "error");
        return;
      }

      // Validar que la salida sea posterior a la entrada
      const entradaDate = new Date(`${fecha}T${entrada}`);
      const salidaDate = new Date(`${fecha}T${salida}`);
      
      if (salidaDate <= entradaDate) {
        showBanner("‚ùå La hora de salida debe ser posterior a la entrada.", "error");
        return;
      }

      // Calcular horas
      const diffMs = salidaDate - entradaDate;
      const diffHrs = diffMs / (1000 * 60 * 60);
      const horas = Math.max(0, Math.round(diffHrs * 100) / 100);

      // Crear registro
      const reg = {
        id: cryptoRandomId(),
        fecha: fecha,
        entradaISO: entrada + ":00",
        salidaISO: salida + ":00",
        horas: horas,
        trabajadorId: trabajadorId
      };

      registros.push(reg);
      guardarDatos();
      refreshUI();
      cerrarModalRegistroManual();
      showBanner(`‚úÖ Registro manual guardado correctamente.`, "success");
    }

    /***************************************************
     * CAMBIO DE CONTRASE√ëA
     ***************************************************/
    function abrirModalCambioPass() {
      if (usuarioActual.rol !== "admin") {
        showBanner("üö´ Acceso denegado. Solo administradores.", "error");
        return;
      }
      document.getElementById("modalCambioPass").style.display = "flex";
    }

    function cerrarModalCambioPass() {
      document.getElementById("modalCambioPass").style.display = "none";
      document.getElementById("nuevaPassword").value = "";
      document.getElementById("confirmarPassword").value = "";
    }

    function guardarCambioPass() {
      const usuario = document.getElementById("selectUsuarioPass").value;
      const nuevaPass = document.getElementById("nuevaPassword").value;
      const confirmarPass = document.getElementById("confirmarPassword").value;

      if (!nuevaPass || !confirmarPass) {
        showBanner("‚ùå Todos los campos son obligatorios.", "error");
        return;
      }

      if (nuevaPass !== confirmarPass) {
        showBanner("‚ùå Las contrase√±as no coinciden.", "error");
        return;
      }

      if (cambiarPassword(usuario, nuevaPass)) {
        showBanner(`‚úÖ Contrase√±a cambiada para ${usuario}`, "success");
        cerrarModalCambioPass();
      } else {
        showBanner("‚ùå Error al cambiar la contrase√±a.", "error");
      }
    }

    /***************************************************
     * EDITAR REGISTRO
     ***************************************************/
    function abrirModalEditarRegistro(registroId) {
      if (usuarioActual.rol !== "admin") {
        showBanner("üö´ Acceso denegado. Solo administradores.", "error");
        return;
      }
      
      const registro = registros.find(r => r.id === registroId);
      if (!registro) return;

      document.getElementById("editarRegistroId").value = registro.id;
      document.getElementById("editarTrabajador").value = registro.trabajadorId;
      document.getElementById("editarFecha").value = registro.fecha;
      document.getElementById("editarEntrada").value = registro.entradaISO ? registro.entradaISO.slice(0,5) : "";
      document.getElementById("editarSalida").value = registro.salidaISO ? registro.salidaISO.slice(0,5) : "";

      document.getElementById("modalEditarRegistro").style.display = "flex";
    }

    function cerrarModalEditarRegistro() {
      document.getElementById("modalEditarRegistro").style.display = "none";
    }

    function guardarEditarRegistro() {
      const registroId = document.getElementById("editarRegistroId").value;
      const trabajadorId = document.getElementById("editarTrabajador").value;
      const fecha = document.getElementById("editarFecha").value;
      const entrada = document.getElementById("editarEntrada").value;
      const salida = document.getElementById("editarSalida").value;

      if (!registroId || !trabajadorId || !fecha || !entrada || !salida) {
        showBanner("‚ùå Todos los campos son obligatorios.", "error");
        return;
      }

      // Validar que la salida sea posterior a la entrada
      const entradaDate = new Date(`${fecha}T${entrada}`);
      const salidaDate = new Date(`${fecha}T${salida}`);
      
      if (salidaDate <= entradaDate) {
        showBanner("‚ùå La hora de salida debe ser posterior a la entrada.", "error");
        return;
      }

      // Calcular horas
      const diffMs = salidaDate - entradaDate;
      const diffHrs = diffMs / (1000 * 60 * 60);
      const horas = Math.max(0, Math.round(diffHrs * 100) / 100);

      // Actualizar registro
      const registro = registros.find(r => r.id === registroId);
      if (registro) {
        registro.trabajadorId = trabajadorId;
        registro.fecha = fecha;
        registro.entradaISO = entrada + ":00";
        registro.salidaISO = salida + ":00";
        registro.horas = horas;
        
        guardarDatos();
        refreshUI();
        cerrarModalEditarRegistro();
        showBanner(`‚úÖ Registro actualizado correctamente.`, "success");
      }
    }

    /***************************************************
     * TOGGLE PASSWORD VISIBILITY
     ***************************************************/
    function togglePasswordVisibility(inputId, iconId) {
      const input = document.getElementById(inputId);
      const icon = document.getElementById(iconId);
      
      if (input.type === "password") {
        input.type = "text";
        icon.innerHTML = '<i class="fas fa-eye-slash"></i>';
      } else {
        input.type = "password";
        icon.innerHTML = '<i class="fas fa-eye"></i>';
      }
    }

    /***************************************************
     * TABLA Y EXPORTS
     ***************************************************/
    function obtenerDatosFiltrados() {
      const trabajadorId = document.getElementById("selectorTrabajador").value;
      const mes = document.getElementById("mesSeleccionado").value;
      const desde = document.getElementById("fDesde").value;
      const hasta = document.getElementById("fHasta").value;

      let datos = [...registros];

      if (trabajadorId && trabajadorId !== "ALL") datos = datos.filter(r => r.trabajadorId === trabajadorId);
      if (desde || hasta) {
        if (desde) datos = datos.filter(r => r.fecha >= desde);
        if (hasta) datos = datos.filter(r => r.fecha <= hasta);
      } else if (mes) {
        datos = datos.filter(r => r.fecha.startsWith(mes));
      }

      return { datos, trabajadorId, mes, desde, hasta };
    }

    function renderTabla() {
      const tbody = document.querySelector("#tablaHoras tbody");
      tbody.innerHTML = "";
      const { datos } = obtenerDatosFiltrados();
      const tById = new Map(trabajadores.map(t => [t.id, t]));

      if (!datos.length) {
        tbody.innerHTML = `<tr><td colspan="6" class="text-center py-8 text-gray-500">No hay registros</td></tr>`;
        document.getElementById("totalHoras").textContent = "0.00";
        return;
      }

      let total = 0;
      datos.sort((a,b) => (a.fecha + a.entradaISO).localeCompare(b.fecha + b.entradaISO));
      datos.forEach(r => {
        total += r.horas || 0;
        const trabajador = tById.get(r.trabajadorId) || {};
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${trabajador.numero || ""}</td>
          <td>${r.fecha}</td>
          <td>${r.entradaISO ? formatTimeForRender(r.entradaISO) : ""}</td>
          <td>${r.salidaISO ? formatTimeForRender(r.salidaISO) : ""}</td>
          <td>${(r.horas||0).toFixed(2)}</td>
          <td>
            ${usuarioActual && usuarioActual.rol === "admin" ? 
              `<button class="action-btn btn-blue" onclick="abrirModalEditarRegistro('${r.id}')">
                <i class="fas fa-edit"></i>
              </button>` : 
              ""
            }
          </td>
        `;
        tbody.appendChild(tr);
      });
      document.getElementById("totalHoras").textContent = total.toFixed(2);
    }

    /** CSV */
    function exportCSV() {
      const { datos, trabajadorId, mes, desde, hasta } = obtenerDatosFiltrados();
      const header = ["Trabajador N¬∫","Nombre","DNI","Fecha","Entrada","Salida","Horas"];
      const lines = [header.join(";")];

      const tById = new Map(trabajadores.map(t => [t.id, t]));
      let total = 0;
      datos.forEach(r => {
        const t = tById.get(r.trabajadorId) || {};
        total += r.horas || 0;
        lines.push([
          t.numero ?? "",
          t.nombre ?? "",
          t.dni ?? "",
          r.fecha,
          r.entradaISO,
          r.salidaISO,
          (r.horas||0).toFixed(2)
        ].join(";"));
      });
      lines.push(["","","","TOTAL","","", total.toFixed(2)].join(";"));

      const filtro = mes ? `mes_${mes}` : (desde || hasta) ? `rango_${desde||""}_${hasta||""}` : "todos";
      downloadBlob(`horas_${filtro}.csv`, "text/csv;charset=utf-8", lines.join("\n"));
      showBanner("üìÑ CSV exportado.", "success");
    }

    /** Excel simple (HTML table -> abre en Excel) */
    function exportExcel() {
      const { datos, mes, desde, hasta } = obtenerDatosFiltrados();
      const tById = new Map(trabajadores.map(t => [t.id, t]));
      let total = 0;

      let html = `
        <table border="1">
          <tr><th colspan="7">Registro de Horas</th></tr>
          <tr><th>Trabajador N¬∫</th><th>Nombre</th><th>DNI</th><th>Fecha</th><th>Entrada</th><th>Salida</th><th>Horas</th></tr>
      `;
      datos.sort((a,b) => (a.fecha + a.entradaISO).localeCompare(b.fecha + b.entradaISO))
           .forEach(r => {
            const t = tById.get(r.trabajadorId) || {};
            total += r.horas || 0;
            html += `<tr>
              <td>${t.numero ?? ""}</td>
              <td>${t.nombre ?? ""}</td>
              <td>${t.dni ?? ""}</td>
              <td>${r.fecha}</td>
              <td>${r.entradaISO}</td>
              <td>${r.salidaISO}</td>
              <td>${(r.horas||0).toFixed(2)}</td>
            </tr>`;
           });
      html += `<tr><td colspan="6"><b>Total</b></td><td><b>${total.toFixed(2)}</b></td></tr>`;
      html += `</table>`;

      const filtro = mes ? `mes_${mes}` : (desde || hasta) ? `rango_${desde||""}_${hasta||""}` : "todos";
      downloadBlob(`horas_${filtro}.xls`, "application/vnd.ms-excel", html);
      showBanner("üìä Excel exportado.", "success");
    }

    /** PDF completo */
    function exportPDF() {
      const { datos, mes, desde, hasta } = obtenerDatosFiltrados();
      const tById = new Map(trabajadores.map(t => [t.id, t]));
      const rows = [];
      let total = 0;

      datos.sort((a,b) => (a.fecha + a.entradaISO).localeCompare(b.fecha + b.entradaISO)).forEach(r => {
        const t = tById.get(r.trabajadorId) || {};
        total += r.horas || 0;
        rows.push([t.numero ?? "", t.nombre ?? "", t.dni ?? "", r.fecha, r.entradaISO, r.salidaISO, (r.horas||0).toFixed(2)]);
      });

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      const titulo = "Registro de Horas";
      const sub = mes ? `Mes: ${mes}` : (desde || hasta) ? `Desde: ${desde || "‚Äî"}  Hasta: ${hasta || "‚Äî"}` : "Todos los registros";

      doc.setFontSize(16);
      doc.text(titulo, 14, 16);
      doc.setFontSize(10);
      doc.text(sub, 14, 22);

      doc.autoTable({
        head: [["N¬∫","Nombre","DNI","Fecha","Entrada","Salida","Horas"]],
        body: rows,
        startY: 28,
        styles: { fontSize: 9 },
        headStyles: { fillColor: [102, 126, 234] }
      });

      const y = doc.lastAutoTable.finalY + 8;
      doc.setFontSize(12);
      doc.text(`Total de horas: ${total.toFixed(2)} h`, 14, y);

      const filtro = mes ? `mes_${mes}` : (desde || hasta) ? `rango_${desde||""}_${hasta||""}` : "todos";
      doc.save(`horas_${filtro}.pdf`);
      showBanner("üßæ PDF exportado.", "success");
    }

    /** PDF Resumen (por d√≠a) */
    function exportPDFResumen() {
      const { datos, mes, desde, hasta } = obtenerDatosFiltrados();
      const mapDia = {};
      datos.forEach(r => {
        mapDia[r.fecha] = (mapDia[r.fecha] || 0) + (r.horas || 0);
      });
      const rows = Object.entries(mapDia)
        .sort((a,b)=>a[0].localeCompare(b[0]))
        .map(([fecha, horas]) => [fecha, horas.toFixed(2)]);

      const total = rows.reduce((acc, r) => acc + parseFloat(r[1]), 0);

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(16);
      doc.text("Resumen de Horas por D√≠a", 14, 16);
      const sub = mes ? `Mes: ${mes}` : (desde || hasta) ? `Desde: ${desde || "‚Äî"}  Hasta: ${hasta || "‚Äî"}` : "Todos los registros";
      doc.setFontSize(10);
      doc.text(sub, 14, 22);

      doc.autoTable({
        head: [["Fecha","Total Horas"]],
        body: rows,
        startY: 28,
        styles: { fontSize: 10 },
        headStyles: { fillColor: [118, 75, 162] }
      });

      const y = doc.lastAutoTable.finalY + 8;
      doc.setFontSize(12);
      doc.text(`Total acumulado: ${total.toFixed(2)} h`, 14, y);

      const filtro = mes ? `mes_${mes}` : (desde || hasta) ? `rango_${desde||""}_${hasta||""}` : "todos";
      doc.save(`horas_resumen_${filtro}.pdf`);
      showBanner("üìÑ Resumen PDF exportado.", "success");
    }

    /***************************************************
     * UI INIT & EVENTS
     ***************************************************/
    function refreshUI() {
      actualizarSelector();
      renderTabla();
    }

    // Inicializaci√≥n
    document.addEventListener("DOMContentLoaded", () => {
      // Verificar sesi√≥n
      const savedUser = lsGet("usuarioActual", null);
      if (savedUser) {
        usuarioActual = savedUser;
        document.getElementById("loginContainer").style.display = "none";
        document.getElementById("btnRegistroManual").style.display = 
          usuarioActual.rol === "admin" ? "block" : "none";
        document.getElementById("btnCambioPass").style.display = 
          usuarioActual.rol === "admin" ? "block" : "none";
      }

      // Tema
      const savedTheme = lsGet("theme", "light");
      applyTheme(savedTheme);
      document.getElementById("toggleTheme").addEventListener("click", () => {
        const current = document.documentElement.getAttribute("data-theme");
        applyTheme(current === "dark" ? "light" : "dark");
      });

      // Eventos para el cambio de contrase√±a
      document.getElementById("btnCambioPass").addEventListener("click", abrirModalCambioPass);
      document.getElementById("cerrarModalCambioPass").addEventListener("click", cerrarModalCambioPass);
      document.getElementById("btnCancelarCambioPass").addEventListener("click", cerrarModalCambioPass);
      document.getElementById("btnGuardarCambioPass").addEventListener("click", guardarCambioPass);
      
      // Toggle password visibility for change password modal
      document.getElementById("toggleNewPassword").addEventListener("click", function() {
        togglePasswordVisibility("nuevaPassword", "toggleNewPassword");
      });
      document.getElementById("toggleConfirmPassword").addEventListener("click", function() {
        togglePasswordVisibility("confirmarPassword", "toggleConfirmPassword");
      });
    });

// --- BLOQUE FINAL DE CONTROL: LOGIN, REGISTROS Y MODALES ---

document.addEventListener("DOMContentLoaded", () => {
    console.log("‚úÖ Sistema de control de interfaz cargado.");

    // 1. LOGIN Y ACCESO
    const btnLogin = document.getElementById("btnLogin");
    if (btnLogin) {
        btnLogin.onclick = async () => {
            const userEl = document.getElementById("loginUsuario");
            const passEl = document.getElementById("loginPassword");
            
            if (typeof login === 'function' && login(userEl.value, passEl.value)) {
                console.log("üîê Login correcto. Sincronizando datos...");
                
                // Descarga profunda para que el PC 1 vea lo del PC 2
                if (typeof descargarDatosNube === 'function') {
                    await descargarDatosNube();
                }
                
                document.getElementById("loginContainer").classList.add("hidden");
                console.log("üöÄ PC 1 actualizado y dentro.");
            } else {
                alert("Usuario o contrase√±a incorrectos");
            }
        };
    }

    // 2. VER CONTRASE√ëA (EL OJO)
    const btnOjo = document.getElementById("toggleLoginPassword");
    if (btnOjo) {
        btnOjo.onclick = () => {
            const passField = document.getElementById("loginPassword");
            if (passField) {
                passField.type = passField.type === "password" ? "text" : "password";
            }
        };
    }

    // 3. LOGOUT
    const btnLogout = document.getElementById("btnLogout");
    if (btnLogout) {
        btnLogout.onclick = () => {
            if (typeof logout === 'function') logout();
        };
    }

    // 4. REGISTRO DE ENTRADAS/SALIDAS
    const btnRegistro = document.getElementById("btnRegistro");
    if (btnRegistro) {
        btnRegistro.onclick = () => {
            const input = document.getElementById("inputRegistro");
            const radio = document.querySelector('input[name="regTipo"]:checked');
            if (radio && typeof registrarEntradaSalida === 'function') {
                registrarEntradaSalida(input.value, radio.value);
                input.value = "";
            }
        };
    }

    // 5. GESTI√ìN DE TRABAJADORES (ALTA/BAJA)
    const btnAlta = document.getElementById("btnAlta");
    if (btnAlta) {
        btnAlta.onclick = () => {
            const n = document.getElementById("inputNombre").value;
            const d = document.getElementById("inputDNI").value;
            if (typeof altaTrabajador === 'function') {
                altaTrabajador(n, d);
                document.getElementById("inputNombre").value = "";
                document.getElementById("inputDNI").value = "";
            }
        };
    }

    // 6. EXPORTACIONES
    const vincular = (id, fn) => {
        const el = document.getElementById(id);
        if (el) el.onclick = fn;
    };

    vincular("btnExportar", () => typeof exportCSV === 'function' && exportCSV());
    vincular("btnExportarExcel", () => typeof exportExcel === 'function' && exportExcel());
    vincular("btnExportarPDF", () => typeof exportPDF === 'function' && exportPDF());
    vincular("btnExportarPDFResumen", () => typeof exportPDFResumen === 'function' && exportPDFResumen());

    // 7. MODALES Y FILTROS
    vincular("btnRegistroManual", () => typeof abrirModalRegistroManual === 'function' && abrirModalRegistroManual());
    vincular("cerrarModal", () => typeof cerrarModalRegistroManual === 'function' && cerrarModalRegistroManual());
    vincular("btnCancelarManual", () => typeof cerrarModalRegistroManual === 'function' && cerrarModalRegistroManual());
    vincular("btnGuardarManual", () => typeof guardarRegistroManual === 'function' && guardarRegistroManual());

    vincular("cerrarModalEditar", () => typeof cerrarModalEditarRegistro === 'function' && cerrarModalEditarRegistro());
    vincular("btnCancelarEditar", () => typeof cerrarModalEditarRegistro === 'function' && cerrarModalEditarRegistro());
    vincular("btnGuardarEditar", () => typeof guardarEditarRegistro === 'function' && guardarEditarRegistro());

    // 8. CIERRE DE MODALES AL CLICAR FUERA
    window.onclick = (e) => {
        const modalReg = document.getElementById("modalRegistroManual");
        const modalEdi = document.getElementById("modalEditarRegistro");
        const modalPass = document.getElementById("modalCambioPass");
        
        if (e.target === modalReg) cerrarModalRegistroManual();
        if (e.target === modalEdi) cerrarModalEditarRegistro();
        if (e.target === modalPass) cerrarModalCambioPass();
    };

    // Inicializar UI al cargar
    if (typeof refreshUI === 'function') refreshUI();
});

</script>
</body>
</html>
